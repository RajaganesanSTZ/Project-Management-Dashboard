<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Project Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CRITICAL PRELOADER STYLE */
        #app-preloader {
            position: fixed;
            inset: 0;
            background: #0f172a;
            /* Slate 900 */
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        .preloader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-radius: 50%;
            border-top-color: #198754;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- CSS VARIABLES & RESET --- */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            /* Light Theme - Professional Palette */
            /* Light Theme - Professional Palette */
            --primary: #198754;
            /* Custom Green */
            --primary-hover: #157347;
            --success: #10b981;
            /* Emerald 500 */
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            /* Amber 500 */
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            /* Red 500 */
            --danger-bg: #fef2f2;
            --info: #3b82f6;
            /* Blue 500 */
            --info-bg: #eff6ff;

            --bg-body: #f8fafc;
            /* Slate 50 */
            --bg-card: #ffffff;
            --text-main: #0f172a;
            /* Slate 900 */
            --text-secondary: #334155;
            /* Slate 700 */
            --text-light: #64748b;
            /* Slate 500 */
            --border: #e2e8f0;
            /* Slate 200 */
            --divider: #f1f5f9;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --font-main: 'Inter', sans-serif;
            --transition: all 0.2s ease-in-out;
        }

        :root[data-theme="dark"] {
            /* Dark Theme - Deep & Sleek */
            --primary: #198754;
            /* Custom Green */
            --primary-hover: #20a766;
            --success: #34d399;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger: #f87171;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --info: #60a5fa;
            --info-bg: rgba(59, 130, 246, 0.1);

            --bg-body: #0f172a;
            /* Slate 900 */
            --bg-card: #1e293b;
            /* Slate 800 */
            --text-main: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-light: #94a3b8;
            --border: #334155;
            --divider: #1e293b;

            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            color-scheme: dark;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        :root[data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 60px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- UTILITIES --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
            letter-spacing: 0.01em;
            white-space: nowrap;
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* Nav Toggle (Hamburger) */
        .nav-toggle-btn {
            display: none;
            /* Hidden on desktop */
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-main);
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition);
        }

        .nav-toggle-btn:hover {
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-white {
            background: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border);
        }

        .btn-white:hover {
            background: var(--divider);
            border-color: var(--text-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger-ghost {
            background: transparent;
            color: var(--danger);
            border-color: transparent;
            box-shadow: none;
        }

        .btn-danger-ghost:hover {
            background: var(--danger-bg);
        }

        /* --- TABS --- */
        .tab-group {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            gap: 2rem;
        }

        .tab {
            padding: 0.8rem 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--text-main);
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            text-align: left;
            background: var(--bg-card);
        }

        .file-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: var(--text-main);
            transition: var(--transition);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background-color: var(--divider);
        }

        .file-item i {
            color: var(--text-light);
        }

        /* --- LOGIN SCREEN --- */
        #connect-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .file-drop-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 3rem;
            background: var(--bg-body);
        }

        .file-drop-area:hover,
        .file-drop-area.dragover {
            border-color: var(--primary);
            background: var(--info-bg);
        }

        /* --- LAYOUT --- */
        nav {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            height: 72px;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s ease;
        }

        /* Desktop Nav Styles */
        @media (min-width: 1025px) {
            #nav-menu {
                overflow-x: auto;
                max-width: 100%;
                padding-bottom: 4px;
            }
        }

        .brand {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .brand i {
            color: #107c41;
            font-size: 1.6rem;
        }

        .container {
            width: 92%;
            max-width: 1600px;
            margin: 2rem auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* --- METRICS CARDS --- */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        /* --- CHARTS --- */
        .grid-charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .grid-charts {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* --- TABLE & CONTROLS --- */
        .controls-bar {
            background: var(--bg-card);
            padding: 0.8rem 1rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping so menu isn't cut off */
            gap: 0.75rem;
            align-items: center;
            /* overflow: visible; implicitly visible, do not clip */
        }

        .search-wrapper {
            position: relative;
            flex: 1 1 200px;
            max-width: 400px;
            min-width: 150px;
        }

        /* Updated Search Bar Styles */
        .search-wrapper {
            position: relative;
            flex: 1 1 250px;
            max-width: 500px;
            min-width: 200px;
        }

        .search-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            /* Accent Color */
            pointer-events: none;
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            /* More left padding for icon */
            border: 1px solid var(--border);
            border-radius: 99px;
            /* Pill Shape */
            font-size: 0.95rem;
            background: var(--bg-body);
            color: var(--text-main);
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            background: var(--bg-card);
            outline: none;
        }

        select.form-input {
            padding-left: 1rem;
        }

        input[type="file"] {
            display: none;
        }

        /* Form Page Styles */
        .page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--divider);
        }

        .page-header h2 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .form-card {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.6rem;
            color: var(--text-secondary);
        }

        .form-input-field {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-body);
            color: var(--text-main);
            transition: var(--transition);
        }

        .form-input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--bg-card);
        }

        .form-footer {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Table Styling */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-scroll {
            overflow-x: auto;
            max-height: 700px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            text-align: left;
        }

        th {
            background: var(--bg-body);
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: var(--divider);
            color: var(--primary);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--divider);
            font-size: 0.95rem;
            vertical-align: middle;
            color: var(--text-secondary);
            transition: background-color 0.1s;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover td {
            background-color: var(--bg-body);
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            line-height: 1.2;
        }

        .badge-success {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge-info {
            background: var(--info-bg);
            color: var(--info);
        }

        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .badge-gray {
            background: var(--divider);
            color: var(--text-light);
        }

        .badge-golive {
            background-color: #16a34a !important;
            /* Green 600 */
            color: #ffffff !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        :root[data-theme="dark"] .badge-golive {
            background-color: #22c55e !important;
            /* Green 500 */
            color: #ffffff !important;
            border: 1px solid #16a34a;
        }

        .badge-danger {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .badge-cyan {
            background: rgba(34, 211, 238, 0.15);
            color: #06b6d4;
        }

        :root[data-theme="dark"] .badge-cyan {
            background: rgba(34, 211, 238, 0.15);
            color: #22d3ee;
        }

        .badge-indigo {
            background: rgba(99, 102, 241, 0.15);
            color: #4f46e5;
        }

        :root[data-theme="dark"] .badge-indigo {
            background: rgba(129, 140, 248, 0.15);
            color: #818cf8;
        }

        :root[data-theme="dark"] .badge-indigo {
            background: rgba(129, 140, 248, 0.15);
            color: #818cf8;
        }

        /* Multi Select Styles */
        .multi-select-container {
            position: relative;
            display: inline-block;
            min-width: 160px;
        }

        .multi-select-trigger {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            user-select: none;
        }

        .multi-select-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10000;
            /* Increased z-index */
            max-height: 300px;
            overflow-y: auto;
            border-radius: var(--radius-md);
            padding: 0.5rem;
            margin-top: 4px;
        }

        .multi-select-menu.open {
            display: block;
        }

        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            cursor: pointer;
            color: var(--text-main);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .multi-select-item:hover {
            background: var(--bg-body);
        }

        .multi-select-item input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        /* Loader */
        .loader-line {
            height: 4px;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            background: linear-gradient(to right, var(--primary), var(--success));
            animation: loading 1.5s infinite ease-in-out;
            display: none;
        }

        @keyframes loading {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 1.5rem;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-card);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .page-btn:hover {
            background: var(--divider);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }

        /* --- RESPONSIVE --- */
        .date-filter-box {
            background: var(--bg-body);
            padding: 0.35rem 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .date-filter-box span {
            font-weight: 500;
            font-size: 0.85rem;
        }

        .date-filter-box input {
            background: transparent;
            border: none;
            color: var(--text-main);
            font-family: inherit;
        }

        @media (max-width: 1024px) {

            /* Navigation Mobile Overhaul */
            nav {
                height: 72px;
                /* Fixed height header */
                padding: 0 1rem;
                /* Match Container Padding */
                flex-direction: row;
                /* Keep row for Brand + Burger */
                align-items: center;
                justify-content: space-between;
                flex-wrap: nowrap;
            }

            .nav-toggle-btn {
                display: block;
            }

            /* The Menu Container */
            #nav-menu {
                display: none;
                /* Hidden by default */
                position: absolute;
                top: 72px;
                /* Below the header */
                left: 0;
                right: 0;
                background: var(--bg-card);
                border-bottom: 1px solid var(--border);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                padding: 1rem;
                flex-direction: column;
                gap: 0.8rem !important;
                z-index: 51;
                /* Above Header */
                /* Animation */
                animation: slideDown 0.2s ease-out;
            }

            #nav-menu.active {
                display: flex;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            #nav-menu .btn {
                width: 100%;
                /* Full width buttons */
                justify-content: center;
            }

            #nav-menu .nav-divider {
                width: 100% !important;
                height: 1px !important;
                margin: 0.5rem 0 !important;
            }

            .btn-text {
                display: inline;
                /* Show text in menu */
            }

            /* Stats Grid - Tighter for Mobile */
            .grid-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }

            /* Even smaller screens */
            @media (max-width: 480px) {
                .grid-stats {
                    grid-template-columns: 1fr;
                    /* Stack on very small screens */
                }
            }


            .btn {
                padding: 0.6rem 0.75rem;
                font-size: 0.85rem;
                flex: 1 0 auto;
                /* Grow, but respect content size */
                min-width: fit-content;
                /* Ensure text fits */
                max-width: none;
                /* Allow full width if needed */
            }

            /* Controls Bar - Card Style on Mobile */
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
                height: auto;
                padding: 1rem;
                gap: 1rem;
                margin: 0;
                width: 100%;
                border-radius: var(--radius-lg);
                border: 1px solid var(--border);
                /* Restore standard card look */
            }

            .search-wrapper {
                max-width: 100%;
                width: 100%;
                flex: none;
            }

            #dynamic-filters {
                /* Remove horizontal scroll to allow popups to overflow */
                overflow: visible;
                flex-wrap: wrap;
                /* Stack filters */
                width: 100%;
                justify-content: space-between;
                gap: 0.8rem;
            }

            .multi-select-container {
                width: calc(50% - 0.5rem);
                /* Perfect half width minus gap */
                min-width: unset;
                flex: 1 1 auto;
            }

            .multi-select-trigger {
                width: 100%;
            }

            .multi-select-menu {
                min-width: 100%;
                max-width: 300px;
                left: 0;
            }

            .date-filter-box {
                flex-direction: row;
                /* Keep side-by-side on mobile */
                width: 100%;
                justify-content: space-between;
                padding: 0.6rem;
            }

            .date-filter-box span {
                display: none;
                /* Hide labels on mobile to save space */
            }

            .date-filter-box input {
                width: 45%;
                background: var(--bg-body);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 0.2rem;
                text-align: center;
            }

            /* Main Layout */
            .container {
                padding: 0 1rem;
                width: 100%;
                margin: 1rem auto;
                gap: 2rem;
            }

            /* Stats Grid - Compact 2 Columns */
            .grid-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }

            .card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.6rem;
            }

            .chart-container {
                width: 100%;
                height: 240px;
            }

            /* Responsive Table (Card View) */
            .table-container {
                background: transparent;
                border: none;
                box-shadow: none;
                border-radius: 0;
            }

            .table-scroll {
                overflow: visible;
                max-height: none;
            }

            #mainTable thead {
                display: none;
            }

            #mainTable tbody,
            #mainTable tr,
            #mainTable td {
                display: block;
                width: 100%;
            }

            #mainTable tr {
                background: var(--bg-card);
                margin-bottom: 1rem;
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-sm);
                padding: 1rem;
            }

            #mainTable td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                padding: 0.6rem 0;
                border-bottom: 1px solid var(--divider);
                font-size: 0.9rem;
            }

            #mainTable td:last-child {
                border-bottom: none;
            }

            #mainTable td::before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 0.75rem;
                text-transform: uppercase;
                color: var(--text-light);
                margin-right: 1rem;
                text-align: left;
            }

            /* Connect Screen Mobile */
            .login-box {
                padding: 1.5rem;
                margin: 1rem;
                width: calc(100% - 2rem);
                max-width: 100%;
            }

            .tab-group {
                gap: 1rem;
                justify-content: center;
            }

            .file-drop-area {
                padding: 2rem 1rem;
            }

            /* Forms (Add/Edit) */
            .form-card {
                padding: 1rem;
            }

            .form-footer {
                flex-direction: column;
                gap: 0.75rem;
            }

            .form-footer .btn {
                width: 100%;
            }

            /* Pagination */
            .pagination {
                flex-wrap: wrap;
            }
        }

        .rich-editor-container {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-body);
            overflow: hidden;
            transition: var(--transition);
        }

        .rich-editor-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: var(--divider);
            border-bottom: 1px solid var(--border);
        }

        .editor-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-main);
        }

        :root[data-theme="dark"] .editor-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-content {
            padding: 12px;
            min-height: 120px;
            outline: none;
            color: var(--text-main);
            font-family: inherit;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .editor-content ul,
        .editor-content ol {
            margin: 0;
            padding-left: 20px;
        }
    </style>
</head>

<body style="opacity: 0; transition: opacity 0.3s ease;">
    <!-- PRELOADER -->
    <div id="app-preloader">
        <div class="preloader-spinner"></div>
    </div>

    <div id="loader" class="loader-line"></div>

    <!-- CONNECT SCREEN -->
    <div id="connect-screen">
        <div class="login-box">
            <div class="tab-group">
                <div class="tab active" id="tab-local" onclick="switchTab('local')">Local File</div>
                <div class="tab" id="tab-cloud" onclick="switchTab('cloud')">OneDrive Cloud</div>
            </div>

            <!-- LOCAL MODE -->
            <div id="mode-local">
                <div style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;">
                    <i class="fa-solid fa-file-excel"></i>
                </div>
                <h2 style="margin: 0 0 0.5rem 0; color: var(--text-main);">Excel Dashboard</h2>
                <p style="color: var(--text-light); margin-bottom: 2rem; font-size: 0.95rem;">
                    Open a local .xlsx file to view and update.
                </p>

                <label for="fileInput" class="file-drop-area" id="dropArea">
                    <i class="fa-solid fa-cloud-arrow-up"
                        style="font-size: 2rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                    <div style="font-weight: 600; color: var(--text-main);">Click to Select File</div>
                    <div style="font-size: 0.8rem; color: var(--text-light);">or drag and drop here</div>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFileSelect(event)">
                </label>
            </div>

            <!-- CLOUD MODE -->
            <div id="mode-cloud" class="hidden">
                <div style="font-size: 3rem; color: #0078D4; margin-bottom: 1rem;">
                    <i class="fa-brands fa-microsoft"></i>
                </div>
                <h2 style="margin: 0 0 0.5rem 0; color: var(--text-main);">OneDrive Connect</h2>

                <div id="auth-section">
                    <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.95rem;">
                        Connect to edit files directly on OneDrive.
                    </p>
                    <input type="text" id="clientIdInput" class="form-input" placeholder="Enter Client ID (from Azure)"
                        style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="signIn()"
                        style="width: 100%; justify-content: center; background: #0078D4; border-color: #0078D4;">
                        Sign In with Microsoft
                    </button>
                    <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 1rem;">Requires Azure App Registration.</p>
                </div>

                <div id="file-picker-section" class="hidden">
                    <!-- URL PASTE OPTION -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <label
                            style="display:block; text-align:left; font-weight:600; margin-bottom:0.5rem; color:var(--text-main);">Option
                            1: Paste File Link</label>
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="fileUrlInput" class="form-input"
                                placeholder="Paste 'Copy Link' URL here..." style="background:var(--bg-body);">
                            <button class="btn btn-primary" onclick="loadFromLink()">Load</button>
                        </div>
                        <small
                            style="display:block; text-align:left; color:var(--text-light); margin-top:0.4rem; font-size:0.8rem;">
                            Supports OneDrive/SharePoint "Copy Link" URLs.
                        </small>
                    </div>

                    <p style="font-weight: 600; text-align: left; margin-bottom: 0.5rem; color:var(--text-main);">Option
                        2: Browse Files</p>
                    <div id="onedrive-list" class="file-list">
                        <div style="padding: 1rem; color: #94a3b8;">Loading files...</div>
                    </div>
                    <button class="btn btn-white" onclick="signOut()" style="width: 100%; justify-content: center;">Sign
                        Out</button>
                </div>
            </div>

            <!-- Template Download Helper -->
            <p
                style="font-size: 0.8rem; color: #94a3b8; margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                Need a template? <a href="#" onclick="downloadTemplate()" style="color: var(--primary);">Download
                    Template</a>
            </p>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="app-screen" class="hidden">
        <nav>
            <div class="brand">
                <i class="fa-solid fa-file-excel"></i>
                <span>Excel Dashboard <span class="live-text" id="status-badge"
                        style="font-weight: 400; color: #94a3b8; font-size: 0.9rem;">| Local File</span></span>
            </div>

            <!-- Mobile Toggle -->
            <button class="nav-toggle-btn" onclick="toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>

            <!-- Menu Items -->
            <div id="nav-menu" class="flex items-center gap-2">
                <button class="btn btn-white" onclick="toggleTheme()" title="Toggle Theme">
                    <i id="theme-icon" class="fa-solid fa-moon"></i> <span class="btn-text hidden-desktop"
                        style="display:none;">Toggle Theme</span>
                </button>
                <div style="height: 20px; width: 1px; background: var(--border); margin: 0 0.5rem; flex-shrink: 0;"
                    class="nav-divider">
                </div>
                <!-- Note: btn-text class management handled by CSS media queries -->
                <button class="btn btn-white" onclick="location.reload()" title="Open New File">
                    <i class="fa-solid fa-folder-open"></i> <span class="btn-text">Open New</span>
                </button>
                <button class="btn btn-white" onclick="refreshDashboard()" title="Refresh Data from Cloud">
                    <i class="fa-solid fa-rotate"></i> <span class="btn-text">Refresh</span>
                </button>
                <button class="btn btn-primary" onclick="showAddScreen()" title="Add Task">
                    <i class="fa-solid fa-plus"></i> <span class="btn-text">Add Task</span>
                </button>
                <button class="btn btn-success" onclick="saveAndDownload()" id="saveBtn" title="Save & Download">
                    <i class="fa-solid fa-floppy-disk"></i> <span class="btn-text">Save & Download</span>
                </button>
                <div style="height: 20px; width: 1px; background: var(--border); margin: 0 0.5rem; flex-shrink: 0;"
                    class="nav-divider"></div>
                <button class="btn btn-danger-ghost" onclick="appSignOut()" title="Sign Out / Disconnect">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="btn-text">Sign Out</span>
                </button>
            </div>
        </nav>
        <style>
            /* Helper for showing text only in mobile menu */
            @media (max-width: 1024px) {
                .hidden-desktop {
                    display: inline !important;
                }
            }
        </style>

        <div class="container">

            <div class="controls-bar">
                <div class="search-wrapper">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="form-input" placeholder="Search project, app, owner..."
                        onkeyup="filterData()">
                </div>
                <div id="dynamic-filters" class="flex gap-2 flex-wrap"></div>

                <div class="date-filter-box">
                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-light);">Target Date:</span>
                    <input type="date" id="dateStart" class="form-input" style="width: auto; padding: 0.4rem;"
                        onchange="filterData()">
                    <span style="color: var(--text-light);">-</span>
                    <input type="date" id="dateEnd" class="form-input" style="width: auto; padding: 0.4rem;"
                        onchange="filterData()">
                </div>

                <label class="flex items-center gap-2" style="font-weight: 600; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="overdueFilter" onchange="filterData()"
                        style="width: 16px; height: 16px;">
                    <span style="color: var(--danger);">Overdue Only</span>
                </label>

                <button class="btn btn-white" onclick="resetFilters()" title="Reset Filters"><i
                        class="fa-solid fa-filter-circle-xmark"></i> <span class="btn-text">Reset</span></button>

                <button class="btn btn-white" onclick="exportFilteredData()" title="Export Filtered Data"><i
                        class="fa-solid fa-file-export"></i> <span class="btn-text">Export Filtered</span></button>
            </div>
            <div class="grid-stats">
                <div class="card">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value" id="v-total">0</div>
                </div>
                <div class="card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="v-done" style="color: var(--success);">0</div>
                </div>
                <div class="card">
                    <div class="stat-label">Dev In-Progress</div>
                    <div class="stat-value" id="v-dev" style="color: var(--primary);">0</div>
                </div>
                <div class="card">
                    <div class="stat-label">Yet to Start</div>
                    <div class="stat-value" id="v-yet" style="color: var(--warning);">0</div>
                </div>
                <div class="card">
                    <div class="stat-label">Overdue Items</div>
                    <div class="stat-value" id="v-overdue" style="color: var(--danger);">0</div>
                </div>
                <div class="card">
                    <div class="stat-label">On Hold</div>
                    <div class="stat-value" id="v-hold" style="color: var(--text-light);">0</div>
                </div>
            </div>

            <div class="grid-charts">
                <div class="card">
                    <h4 style="margin: 0 0 1rem 0; font-weight: 700; color: var(--text-main);">Workload by Owner</h4>
                    <div class="chart-container">
                        <canvas id="chartOwner"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin: 0 0 1rem 0; font-weight: 700; color: var(--text-main);">Status Breakdown</h4>
                    <div class="chart-container">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin: 0 0 1rem 0; font-weight: 700; color: var(--text-main);">Tasks by Application</h4>
                    <div class="chart-container">
                        <canvas id="chartApps"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin: 0 0 1rem 0; font-weight: 700; color: var(--text-main);">Monthly Deadline Trend
                    </h4>
                    <div class="chart-container">
                        <canvas id="chartTimeline"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-scroll">
                    <table id="mainTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- ADD TASK SCREEN -->
    <div id="add-screen" class="hidden container">
        <div class="page-header">
            <button class="btn btn-white" onclick="showDashboard()"><i class="fa-solid fa-arrow-left"></i> Back</button>
            <h2>Add New Task</h2>
        </div>
        <div class="card form-card">
            <div id="add-form-body"></div>
            <div class="form-footer">
                <button class="btn btn-primary" onclick="saveAdd()">Save Task</button>
            </div>
        </div>
    </div>

    <!-- EDIT TASK SCREEN -->
    <div id="edit-screen" class="hidden container">
        <div class="page-header">
            <button class="btn btn-white" onclick="showDashboard()"><i class="fa-solid fa-arrow-left"></i> Back</button>
            <h2>Edit Task</h2>
        </div>
        <div class="card form-card">
            <div id="edit-form-body"></div>
            <div class="form-footer" style="justify-content: space-between;">
                <button class="btn btn-danger-ghost" onclick="deleteTask()"><i class="fa-solid fa-trash"></i> Delete
                    Record</button>
                <button class="btn btn-primary" onclick="saveEdit()">Update Task</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        // --- GLOBAL STATE ---
        let rawData = [];
        let filteredData = []; // Store currently filtered data for export
        let headers = ["APP", "PROJECT", "DELIVERABLES", "OWNER", "TARGET DATE", "STATUS", "REMARKS"]; // Defaults
        let charts = { owner: null, status: null, apps: null, timeline: null };
        let editingRow = null;
        let mode = 'local'; // local | cloud
        let accessToken = null;
        let driveId = null;
        let itemId = null;
        let currentTableId = null;
        let currentFileName = "";

        // View State
        let sortCol = null;
        let sortAsc = true;
        let currentPage = 1;
        const rowsPerPage = 25;

        // MSAL CONFIG (Initialized in signIn)
        let msalInstance = null;

        // --- INITIALIZATION ---
        window.onload = async function () {
            // 1. Protocol Handling (Redirect file:// to localhost) - DISABLED
            // if (window.location.protocol === 'file:') { ... }

            // 1. Apply Dynamic Color first
            applyRandomTheme();

            // 2. Init Theme
            let savedTheme = 'dark'; // Default to Dark for premium feel & match preloader
            try {
                const stored = localStorage.getItem('theme');
                if (stored) savedTheme = stored;
            } catch (e) { console.warn("LocalStorage access denied:", e); }

            setTheme(savedTheme);

            // Drag and drop setup ...
            const dropArea = document.getElementById('dropArea');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                dropArea.addEventListener('drop', handleDrop, false);
            }

            // FILE PROTOCOL CHECK (Disable Cloud Features)
            if (window.location.protocol === 'file:') {
                // 1. Mark Tab as Restricted
                const cloudTab = document.getElementById('tab-cloud');
                if (cloudTab) {
                    cloudTab.innerHTML += ' <i class="fa-solid fa-ban" style="font-size:0.8em; opacity:0.6; margin-left:4px;"></i>';
                    cloudTab.title = "Cloud features require a Local Web Server.";
                }

                // 2. Replace Auth Section with Info Message
                const authSection = document.getElementById('auth-section');
                if (authSection) {
                    authSection.innerHTML = `
                        <div style="padding:1rem; border:1px solid var(--warning); background:var(--warning-bg); color:var(--text-main); border-radius:var(--radius-md); margin-bottom:1rem; text-align:center;">
                            <div style="font-weight:600; margin-bottom:0.5rem; color:var(--warning);"><i class="fa-solid fa-triangle-exclamation"></i> Server Required</div>
                            <p style="font-size:0.9rem; margin:0; opacity:0.9;">
                                OneDrive Cloud access requires a web server (http://localhost).
                                <br><br>
                                Please use the <b>Local File</b> tab for direct file access.
                            </p>
                        </div>
                        <button class="btn btn-white" disabled style="opacity:0.5; cursor:not-allowed; width:100%;">
                            Cloud Sign-In Unavailable
                        </button>
                    `;
                }
            } else {
                // ONLY Attempt Auto-Login if NOT on file protocol
                try {
                    const storedCid = localStorage.getItem('azure_client_id');
                    if (storedCid) {
                        document.getElementById('clientIdInput').value = storedCid;
                        tryAutoLogin(storedCid);
                    }
                } catch (e) { console.log("No saved client ID or storage restricted."); }

                // Display Redirect URI Helper
                const redirectUri = window.location.origin + window.location.pathname;
                const authSection = document.getElementById('auth-section');
                if (authSection) {
                    const uriDisplay = document.createElement('div');
                    uriDisplay.style.marginTop = '1rem';
                    uriDisplay.style.padding = '0.75rem';
                    uriDisplay.style.background = 'var(--bg-body)';
                    uriDisplay.style.borderRadius = 'var(--radius-md)';
                    uriDisplay.style.border = '1px dashed var(--border)';
                    uriDisplay.style.fontSize = '0.8rem';
                    uriDisplay.style.textAlign = 'left';
                    uriDisplay.innerHTML = `
                    <div style="color:var(--text-light); margin-bottom:4px;">Redirect URI (Add to Azure):</div>
                    <code style="display:block; word-break:break-all; color:var(--primary); font-family:monospace;">${redirectUri}</code>
                `;
                    authSection.appendChild(uriDisplay);
                }
            }
        };

        async function tryAutoLogin(clientId) {
            console.log("Attempting Auto-Login...");
            try {
                const msalApp = await initMsal();
                if (!msalApp) return;

                const accounts = msalApp.getAllAccounts();
                if (accounts.length > 0) {
                    const tokenRes = await msalApp.acquireTokenSilent({
                        scopes: ["User.Read", "Files.ReadWrite"],
                        account: accounts[0]
                    });

                    if (tokenRes && tokenRes.accessToken) {
                        console.log("Auto-Login Successful");
                        accessToken = tokenRes.accessToken;
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('file-picker-section').classList.remove('hidden');

                        // Check for saved file to auto-load
                        const lastFileId = localStorage.getItem('last_cloud_file_id');
                        const lastFileName = localStorage.getItem('last_cloud_file_name');
                        if (lastFileId && lastFileName) {
                            console.log("Auto-loading saved file:", lastFileName);
                            loadCloudFile(lastFileId, lastFileName);
                        } else {
                            listOneDriveFiles();
                        }
                    }
                }
            } catch (e) {
                console.warn("Auto-login failed (User usually needs to click Connect manually):", e);
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');

            document.getElementById('mode-local').classList.add('hidden');
            document.getElementById('mode-cloud').classList.add('hidden');
            document.getElementById(`mode-${t}`).classList.remove('hidden');
            mode = t;
        }

        // --- AUTH & CLOUD ---
        // Global MSAL Handler


        async function initMsal() {
            // CRITICAL: Check Protocol
            if (window.location.protocol === 'file:') {
                console.warn("Microsoft Login (MSAL) unavailable on file:// protocol. Local file mode works fine.");
                return null;
            }

            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) return null;

            // Clean Redirect URI (No query params, no hash)
            const redirectUri = window.location.origin + window.location.pathname;
            console.log("Configured Redirect URI:", redirectUri);

            if (!msalInstance) {
                msalInstance = new msal.PublicClientApplication({
                    auth: {
                        clientId: clientId,
                        authority: "https://login.microsoftonline.com/common",
                        redirectUri: redirectUri
                    },
                    cache: { cacheLocation: "sessionStorage" }
                });
                await msalInstance.initialize();
            }
            return msalInstance;
        }

        async function signIn() {
            try {
                console.log("Sign In Initiated");
                if (typeof msal === 'undefined') throw new Error("MSAL.js Library not loaded. Check internet connection.");

                const clientId = document.getElementById('clientIdInput').value.trim();
                if (!clientId) { alert("Please enter a Client ID"); return; }
                localStorage.setItem('azure_client_id', clientId);

                const msalApp = await initMsal();
                if (!msalApp) {
                    if (window.location.protocol === 'file:') {
                        alert("Note: OneDrive Cloud features require a web server.\n\n" +
                            "To use the Cloud tab, please run the 'run_dashboard.bat' script included in the folder.\n" +
                            "For now, you can continue using the 'Local File' tab perfectly fine!");
                        return;
                    }
                    throw new Error("Failed to initialize MSAL. Client ID might be missing or invalid.");
                }

                console.log("MSAL Initialized");

                const accounts = msalApp.getAllAccounts();
                let tokenRes;

                if (accounts.length > 0) {
                    try {
                        console.log("Attempting silent token acquisition...");
                        tokenRes = await msalApp.acquireTokenSilent({
                            scopes: ["User.Read", "Files.ReadWrite"],
                            account: accounts[0]
                        });
                    } catch (e) {
                        console.warn("Silent token failed, using popup:", e);
                        tokenRes = await msalApp.loginPopup({ scopes: ["User.Read", "Files.ReadWrite"] });
                    }
                } else {
                    console.log("No accounts found, using popup...");
                    tokenRes = await msalApp.loginPopup({ scopes: ["User.Read", "Files.ReadWrite"] });
                }

                if (!tokenRes || !tokenRes.accessToken) throw new Error("No access token received.");

                accessToken = tokenRes.accessToken;
                console.log("Login Successful");

                // Show file picker
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('file-picker-section').classList.remove('hidden');
                listOneDriveFiles();

            } catch (e) {
                console.error("Login Critical Error:", e);
                const redirectUri = window.location.origin + window.location.pathname;

                if (e.message.includes("AADSTS50011")) {
                    alert("Azure Configuration Error (Redirect URI Mismatch)\n\n" +
                        "Please go to your Azure Portal > Authentication tab.\n" +
                        "Ensure this EXACT URL is listed in 'Single-page application' or 'Web' Redirect URIs:\n\n" +
                        redirectUri + "\n\n" +
                        "Also ensure the scheme (http/https) matches exactly.\n" +
                        "Error Details: " + e.message);
                } else if (e.name === "BrowserAuthError" && e.errorMessage.includes("interaction_in_progress")) {
                    alert("A login popup is already open. Please look for it, close it, or reload this page.");
                } else {
                    alert("Login failed: " + e.message);
                }
            }
        }



        function signOut() {
            sessionStorage.clear();
            location.reload();
        }

        async function callGraph(endpoint, method = 'GET', body = null) {
            const getHeaders = () => ({
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            });

            let url = endpoint.startsWith('http') ? endpoint : `https://graph.microsoft.com/v1.0${endpoint}`;

            // Cache busting for GET
            if (method === 'GET') {
                const separator = url.includes('?') ? '&' : '?';
                url += `${separator}_t=${Date.now()}`;
            }

            let opts = { method: method, headers: getHeaders() };
            if (body) opts.body = JSON.stringify(body);

            let res = await fetch(url, opts);

            // Handle Token Expiry (401)
            if (res.status === 401) {
                console.warn("Access Token expired (401). Attempting silent refresh...");
                try {
                    const msalApp = await initMsal();
                    const accounts = msalApp.getAllAccounts();
                    if (accounts.length > 0) {
                        const tokenRes = await msalApp.acquireTokenSilent({
                            scopes: ["User.Read", "Files.ReadWrite"],
                            account: accounts[0]
                        });
                        accessToken = tokenRes.accessToken;
                        // Retry Request
                        opts.headers = getHeaders();
                        res = await fetch(url, opts);
                    }
                } catch (e) {
                    console.error("Token refresh failed:", e);
                    // Do not throw here, let the next check resolve it as a standard error
                }
            }

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`Graph Error ${res.status}: ${text}`);
            }

            // Handle 204 No Content (DELETE success)
            if (res.status === 204) return {};

            // Handle Empty Body for other statuses if needed
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        }

        // Navigation State
        let currentFolderId = 'root';
        let breadcrumbs = [{ id: 'root', name: 'Home' }];

        async function listOneDriveFiles(folderId = 'root', folderName = null) {
            currentFolderId = folderId;
            if (folderName) {
                if (folderId === 'root') breadcrumbs = [{ id: 'root', name: 'Home' }];
                else if (breadcrumbs[breadcrumbs.length - 1].id !== folderId) breadcrumbs.push({ id: folderId, name: folderName });
            } else if (folderId === 'root') {
                breadcrumbs = [{ id: 'root', name: 'Home' }];
            }

            const listContainer = document.getElementById('onedrive-list');
            listContainer.innerHTML = '<div style="padding:1rem">Scanning...</div>';

            try {
                const endpoint = folderId === 'root'
                    ? '/me/drive/root/children?$select=id,name,file,folder'
                    : `/me/drive/items/${folderId}/children?$select=id,name,file,folder`;

                const data = await callGraph(endpoint);
                const items = data.value.filter(f => f.folder || (f.file && f.name.endsWith('.xlsx')));

                renderFileList(items);
            } catch (e) {
                listContainer.innerHTML = `<div style="padding:1rem;color:red">Error: ${e.message}</div>`;
            }
        }

        async function loadFromLink() {
            const url = document.getElementById('fileUrlInput').value.trim();
            if (!url) {
                alert("Please paste a link first.");
                return;
            }

            showLoader(true);
            try {
                // MS Graph Logic: Convert Sharing URL to Encoded ID
                // 1. Base64 Encode
                let string = btoa(url);
                // 2. Replace chars
                string = string.replace(/\//g, '_').replace(/\+/g, '-');
                // 3. Remove trailing =
                while (string.endsWith('=')) string = string.slice(0, -1);
                // 4. Prefix
                const encodedUrl = "u!" + string;

                console.log("Resolving Link:", encodedUrl);

                const item = await callGraph(`/shares/${encodedUrl}/driveItem`);
                if (item && item.id) {
                    // Success
                    await loadCloudFile(item.id, item.name);
                } else {
                    throw new Error("Could not resolve file info from this link.");
                }
            } catch (e) {
                console.error(e);
                alert("Failed to load link.\n\nEnsure this is a valid OneDrive/SharePoint 'Copy Link' URL and you are signed in with the correct account.\n\nError: " + e.message);
                showLoader(false);
            }
        }

        function renderFileList(items) {
            const listContainer = document.getElementById('onedrive-list');
            listContainer.innerHTML = '';

            // Breadcrumbs
            const navDiv = document.createElement('div');
            navDiv.style.padding = '0.5rem';
            navDiv.style.borderBottom = '1px solid var(--border)';
            navDiv.style.background = '#f8fafc';
            navDiv.style.display = 'flex';
            navDiv.style.gap = '0.5rem';

            if (currentFolderId !== 'root') {
                const backBtn = document.createElement('button');
                backBtn.className = 'btn btn-white';
                backBtn.style.padding = '0.2rem 0.5rem';
                backBtn.style.fontSize = '0.8rem';
                backBtn.innerHTML = '<i class="fa-solid fa-arrow-up"></i> Up';
                backBtn.onclick = () => {
                    breadcrumbs.pop();
                    const prev = breadcrumbs[breadcrumbs.length - 1];
                    listOneDriveFiles(prev.id);
                };
                navDiv.appendChild(backBtn);
            }

            const pathSpan = document.createElement('span');
            pathSpan.style.alignSelf = 'center';
            pathSpan.style.fontSize = '0.8rem';
            pathSpan.style.color = 'var(--text-light)';
            pathSpan.innerText = breadcrumbs.map(b => b.name).join(' / ');
            navDiv.appendChild(pathSpan);
            listContainer.appendChild(navDiv);

            if (items.length === 0) {
                listContainer.innerHTML += '<div style="padding:1rem;color:#94a3b8">No items found.</div>';
                return;
            }

            items.sort((a, b) => (a.folder && !b.folder) ? -1 : 1);

            items.forEach(f => {
                const div = document.createElement('div');
                div.className = 'file-item';
                if (f.folder) {
                    div.innerHTML = `<i class="fa-solid fa-folder" style="color:#f59e0b"></i> <span>${f.name}</span>`;
                    div.onclick = () => listOneDriveFiles(f.id, f.name);
                } else {
                    div.innerHTML = `<i class="fa-solid fa-file-excel"></i> <span>${f.name}</span>`;
                    div.onclick = () => loadCloudFile(f.id, f.name);
                }
                listContainer.appendChild(div);
            });
        }

        async function loadCloudFile(id, name, keepFilters = false) {
            let savedFilters = null;
            if (keepFilters) savedFilters = saveFilterState();
            showLoader(true);
            itemId = id;
            currentFileName = name;

            // Save state for auto-reconnect
            localStorage.setItem('last_cloud_file_id', id);
            localStorage.setItem('last_cloud_file_name', name);

            console.log("Loading file:", name, id);

            try {
                let rows = [];
                let tableId = null;

                // 1. Try finding tables first
                try {
                    const tables = await callGraph(`/me/drive/items/${id}/workbook/tables`);
                    if (tables.value && tables.value.length > 0) {
                        tableId = tables.value[0].id;
                        const range = await callGraph(`/me/drive/items/${id}/workbook/tables/${tableId}/range?select=values`);
                        rows = range.values;
                    }
                } catch (e) {
                    console.log("No table found or error checking tables:", e);
                }

                // 2. Fallback: Read specific worksheet or first one
                if (!rows || rows.length === 0) {
                    console.log("Attempting fallback to Worksheet UsedRange...");
                    try {
                        const sheets = await callGraph(`/me/drive/items/${id}/workbook/worksheets`);

                        if (sheets.value && sheets.value.length > 0) {
                            // Try to find the exact sheet "Project Details" (case insensitive)
                            let targetSheet = sheets.value.find(s => s.name.toLowerCase() === "project details");

                            // If not found, default to the first one
                            if (!targetSheet) {
                                targetSheet = sheets.value.sort((a, b) => a.position - b.position)[0];
                                console.log("Specific sheet 'Project Details' not found. Defaulting to first sheet:", targetSheet.name);
                            } else {
                                console.log("Found specific sheet:", targetSheet.name);
                            }

                            const range = await callGraph(`/me/drive/items/${id}/workbook/worksheets/${targetSheet.id}/usedRange?select=values`);
                            rows = range.values;
                        } else {
                            throw new Error("No worksheets found.");
                        }
                    } catch (e) {
                        console.error("Fallback failed:", e);
                        alert("Failed to read file (No Table & No Sheets).\n" + e.message);
                        showLoader(false);
                        return;
                    }
                }

                if (!rows || rows.length === 0) {
                    alert("File appears empty.");
                    showLoader(false);
                    return;
                }

                // 3. Process Data
                if (rows.length < 2) {
                    // Header only or empty
                    rawData = [];
                    headers = ["APP", "PROJECT", "DELIVERABLES", "OWNER", "TARGET DATE", "STATUS", "REMARKS"];
                } else {
                    let rawHeaders = rows[0].map(h => String(h).trim());

                    // Fuzzy Map Attempt
                    const map = {
                        "APP": ["APP", "APPLICATION", "SYSTEM"],
                        "PROJECT": ["PROJECT", "INITIATIVE", "TITLE", "NAME"],
                        "DELIVERABLES": ["DELIVERABLES", "TASK", "ITEM", "DESCRIPTION"],
                        "OWNER": ["OWNER", "ASSIGNED TO", "LEAD", "RESPONSIBLE"],
                        "TARGET DATE": ["TARGET DATE", "DUE DATE", "DEADLINE", "END DATE"],
                        "STATUS": ["STATUS", "STATE", "STAGE"],
                        "REMARKS": ["REMARKS", "COMMENTS", "NOTES"]
                    };

                    // Create a normalized header list
                    headers = Object.keys(map); // Force our standard headers

                    rawData = rows.slice(1).map((r, i) => {
                        const obj = { _rowIndex: i };

                        // For each standard header, find the best matching source column
                        headers.forEach((stdH, stdIdx) => {
                            // 1. Try name match
                            let sourceIdx = rawHeaders.findIndex(rh => map[stdH].includes(rh.toUpperCase()));

                            // 2. Fallback to index if no name match
                            if (sourceIdx === -1) sourceIdx = stdIdx;

                            // Get value
                            let val = r[sourceIdx] !== undefined ? r[sourceIdx] : "";

                            // Date Cleanup
                            if (stdH === "TARGET DATE" && val) {
                                if (typeof val === 'number') {
                                    // Excel Serial Date
                                    const d = new Date((val - (25567 + 2)) * 86400 * 1000);
                                    if (!isNaN(d.getTime())) val = d.toISOString().split('T')[0];
                                } else {
                                    // String try parse
                                    const d = new Date(val);
                                    if (!isNaN(d.getTime())) val = d.toISOString().split('T')[0];
                                }
                            }

                            obj[stdH] = val;
                        });
                        return obj;
                    }).filter(row => {
                        // Filter out empty rows (Soft Deleted or Blank)
                        const keys = Object.keys(row).filter(k => k !== '_rowIndex');
                        return keys.some(k => row[k] && String(row[k]).trim() !== "");
                    });
                }

                document.getElementById('status-badge').innerText = `| Cloud: ${name}`;

                // UI Status
                // UI Status
                const saveBtn = document.getElementById('saveBtn');
                currentTableId = tableId; // Cache it
                if (tableId) {
                    saveBtn.innerHTML = '<i class="fa-solid fa-cloud"></i> Auto-Sync Active';
                    saveBtn.className = 'btn btn-white';
                    saveBtn.title = "Changes are saved automatically to OneDrive.";
                    saveBtn.disabled = false; // Enable it so it looks active (though click does nothing special)
                } else {
                    saveBtn.innerHTML = '<i class="fa-solid fa-lock"></i> Read Only (Editing Disabled)';
                    saveBtn.className = 'btn btn-danger-ghost';
                    saveBtn.disabled = true;
                    saveBtn.title = "Editing is disabled because no Excel Table was found. Open file in Excel and Insert > Table to enable editing.";

                    // Optional: Show a one-time toast or alert
                    setTimeout(() => alert("NOTICE: File is in Read-Only Mode.\n\nTo enable editing:\n1. Open this file in Excel.\n2. Select your data.\n3. Go to Insert > Table.\n4. Save and reload here."), 500);
                }

                showApp();
                initDashboard();

                // RESTORE FILTERS: Must happen after initDashboard() builds the dropdowns
                if (keepFilters && savedFilters) {
                    restoreFilterState(savedFilters);
                }
            } catch (e) {
                alert("Critical Load Error: " + e.message);
                console.error(e);
            }
            showLoader(false);
        }

        // --- LOCAL FILE HANDLING & COMMON UTILS ---
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function highlight(e) { document.getElementById('dropArea').classList.add('dragover'); }
        function unhighlight(e) { document.getElementById('dropArea').classList.remove('dragover'); }
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            const reader = new FileReader();

            showLoader(true);

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (json.length >= 0) {
                        rawData = json;
                        if (json.length > 0) headers = Object.keys(json[0]);
                        else headers = ["APP", "PROJECT", "DELIVERABLES", "OWNER", "TARGET DATE", "STATUS", "REMARKS"];

                        mode = 'local';
                        currentFileName = file.name;
                        document.getElementById('status-badge').innerText = `| Local: ${file.name}`;
                        document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save & Download';
                        document.getElementById('saveBtn').className = 'btn btn-success';
                        document.getElementById('saveBtn').disabled = false;

                        showApp();
                        initDashboard();
                    }
                } catch (err) {
                    alert("Error reading file: " + err.message);
                }
                showLoader(false);
            };
            reader.readAsArrayBuffer(file);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            setTheme(target);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            try { localStorage.setItem('theme', theme); } catch (e) { }
            const icon = document.getElementById('theme-icon');
            if (icon) icon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            if (rawData.length > 0) filterData();
        }

        function downloadTemplate() {
            const row = { "APP": "Example", "PROJECT": "Project X", "DELIVERABLES": "Notes", "OWNER": "User", "TARGET DATE": "2025-01-01", "STATUS": "YET TO START", "REMARKS": "" };
            const ws = XLSX.utils.json_to_sheet([row]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tasks");
            XLSX.writeFile(wb, "Dashboard_Template.xlsx");
        }

        function saveAndDownload() {
            if (mode === 'cloud') {
                return; // Auto-sync is handled in Cloud mode
            }
            if (!rawData || rawData.length === 0) { alert("No data to save."); return; }
            showLoader(true);
            try {
                const ws = XLSX.utils.json_to_sheet(rawData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                const d = new Date();
                const dateStr = d.toLocaleDateString('en-GB').replace(/\//g, '-');
                const timeStr = d.toLocaleTimeString('en-GB').replace(/:/g, '-');
                XLSX.writeFile(wb, `Project_Dashboard_${dateStr}_${timeStr}.xlsx`);
            } catch (e) { alert("Error saving file: " + e.message); }
            showLoader(false);
        }

        function exportFilteredData() {
            if (!filteredData || filteredData.length === 0) { alert("No filtered data to export."); return; }
            showLoader(true);
            try {
                // Remove internal fields like _rowIndex before export if desired, or just export as is.
                // Better to cleanup:
                const cleanData = filteredData.map(row => {
                    const { _rowIndex, ...rest } = row;
                    return rest;
                });

                const ws = XLSX.utils.json_to_sheet(cleanData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Filtered_Tasks");
                const d = new Date();
                const dateStr = d.toLocaleDateString('en-GB').replace(/\//g, '-');
                XLSX.writeFile(wb, `Filtered_Dashboard_${dateStr}.xlsx`);
            } catch (e) { alert("Error exporting: " + e.message); }
            showLoader(false);
        }

        function appSignOut() {
            if (confirm("Are you sure you want to sign out and disconnect current file?")) {
                localStorage.removeItem('last_cloud_file_id');
                localStorage.removeItem('last_cloud_file_name');
                signOut(); // calls sessionStorage.clear() & reload
            }
        }

        function showApp() {
            document.getElementById('connect-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('nav-menu');
            menu.classList.toggle('active');
        }

        // --- CORE LOGIC ---
        async function refreshDashboard() {
            if (mode === 'cloud' && itemId) {
                // Add spin animation to icon
                const btn = document.querySelector('button[onclick="refreshDashboard()"]');
                const icon = btn ? btn.querySelector('i') : null;
                if (icon) icon.classList.add('fa-spin');

                try {
                    await loadCloudFile(itemId, currentFileName, true);
                    // Optional: Toast "Refreshed"
                } catch (e) {
                    console.error("Refresh failed:", e);
                } finally {
                    if (icon) icon.classList.remove('fa-spin');
                }
            } else if (mode === 'local') {
                // Try to auto-refresh if file is accessible via fetch (e.g. localhost same dir)
                if (currentFileName) {
                    const btn = document.querySelector('button[onclick="refreshDashboard()"]');
                    const icon = btn ? btn.querySelector('i') : null;
                    if (icon) icon.classList.add('fa-spin');

                    showLoader(true);

                    try {
                        // Attempt to fetch file (cache busting)
                        const response = await fetch(currentFileName + '?t=' + Date.now());
                        if (!response.ok) throw new Error("Fetch failed");

                        const arrayBuffer = await response.arrayBuffer();
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        if (json.length >= 0) {
                            const savedFilters = saveFilterState();

                            rawData = json;
                            if (json.length > 0) headers = Object.keys(json[0]);
                            else headers = ["APP", "PROJECT", "DELIVERABLES", "OWNER", "TARGET DATE", "STATUS", "REMARKS"];

                            initDashboard();
                            restoreFilterState(savedFilters);
                        }
                    } catch (e) {
                        // Fallback to original alert if fetch fails (e.g. file protocol)
                        console.warn("Auto-refresh failed, showing alert:", e);
                        alert("For local files, changes made outside this dashboard will not appear until you re-open the file (Browser Security Restriction).\n\nTip: If you are running this on a local server (localhost), ensure the Excel file is in the same folder as this dashboard to enable Auto-Refresh.");
                    } finally {
                        showLoader(false);
                        if (icon) icon.classList.remove('fa-spin');
                    }
                }
            } else {
                alert("Please open a file first.");
            }
        }

        // --- FILTER & SORT ---
        function initDashboard() {
            buildFilters();
            filterData();
        }

        function buildFilters() {
            const container = document.getElementById('dynamic-filters');
            container.innerHTML = '';
            const viableFilters = ['APP', 'STATUS', 'OWNER'];

            viableFilters.forEach(colName => {
                const realHeader = headers.find(h => h.toUpperCase() === colName);
                if (!realHeader) return;

                const values = [...new Set(rawData.map(r => r[realHeader]))].filter(v => v).sort();

                // Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'multi-select-container';
                wrapper.setAttribute('data-col', realHeader);

                // Trigger Button
                const trigger = document.createElement('div');
                trigger.className = 'form-input multi-select-trigger';
                trigger.innerHTML = `<span class="label">${realHeader}</span> <i class="fa-solid fa-chevron-down" style="font-size:0.7em; opacity:0.7;"></i>`;
                trigger.onclick = (e) => {
                    e.stopPropagation();
                    closeAllMultiSelects(wrapper); // close others
                    menu.classList.toggle('open');
                };

                // Dropdown Menu
                const menu = document.createElement('div');
                menu.className = 'multi-select-menu';

                // "Select All" Option
                const allDiv = document.createElement('label');
                allDiv.className = 'multi-select-item';
                allDiv.style.borderBottom = '1px solid var(--border)';
                allDiv.style.marginBottom = '4px';
                allDiv.style.paddingBottom = '8px';
                allDiv.innerHTML = `<input type="checkbox" value="All" checked onchange="handleMultiSelectChange(this)"> <span>Select All</span>`;
                menu.appendChild(allDiv);

                values.forEach(v => {
                    const item = document.createElement('label');
                    item.className = 'multi-select-item';
                    item.innerHTML = `<input type="checkbox" value="${v}" checked onchange="handleMultiSelectChange(this)"> <span>${v}</span>`;
                    // Prevent closing when clicking the item
                    item.onclick = (e) => e.stopPropagation();
                    menu.appendChild(item);
                });

                // Prevent closing when clicking Select All
                allDiv.onclick = (e) => e.stopPropagation();

                wrapper.appendChild(trigger);
                wrapper.appendChild(menu);
                container.appendChild(wrapper);
            });

            // Click outside to close
            document.addEventListener('click', () => closeAllMultiSelects());
        }

        function closeAllMultiSelects(except) {
            document.querySelectorAll('.multi-select-menu.open').forEach(m => {
                if (!except || !except.contains(m)) m.classList.remove('open');
            });
        }

        function handleMultiSelectChange(checkbox) {
            const menu = checkbox.closest('.multi-select-menu');
            const container = menu.closest('.multi-select-container');
            const colName = container.getAttribute('data-col');
            const triggerLabel = container.querySelector('.label');
            const allBoxes = menu.querySelectorAll('input[type="checkbox"]:not([value="All"])');
            const allCheckbox = menu.querySelector('input[value="All"]');

            if (checkbox.value === 'All') {
                // Toggle all based on "All" status
                allBoxes.forEach(cb => cb.checked = checkbox.checked);
            } else {
                // If one unchecked, uncheck "All". If all checked, check "All".
                if (!checkbox.checked) allCheckbox.checked = false;
                else {
                    const allChecked = Array.from(allBoxes).every(cb => cb.checked);
                    allCheckbox.checked = allChecked;
                }
            }

            // Update Label
            const checkedCount = Array.from(allBoxes).filter(cb => cb.checked).length;
            if (checkedCount === allBoxes.length) triggerLabel.innerText = colName;
            else if (checkedCount === 0) triggerLabel.innerText = `${colName} (0)`;
            else triggerLabel.innerText = `${colName} (${checkedCount})`;

            filterData();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.getElementById('overdueFilter').checked = false;

            // Reset Multi-selects
            document.querySelectorAll('.multi-select-menu').forEach(menu => {
                menu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                const container = menu.closest('.multi-select-container');
                const colName = container.getAttribute('data-col');
                container.querySelector('.label').innerText = colName;
            });

            filterData();
        }

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filterContainers = document.querySelectorAll('.multi-select-container');

            // Gather active filters
            const activeFilters = {};
            filterContainers.forEach(con => {
                const col = con.getAttribute('data-col');
                const menu = con.querySelector('.multi-select-menu');
                // If "All" is checked, we don't need to filter by this column (optimization)
                // But strictly speaking: get all checked values
                const allCb = menu.querySelector('input[value="All"]');
                if (!allCb.checked) {
                    const checkedValues = Array.from(menu.querySelectorAll('input[type="checkbox"]:not([value="All"]):checked')).map(cb => cb.value);
                    if (checkedValues.length > 0) activeFilters[col] = checkedValues;
                }
            });

            filteredData = rawData.filter(row => {
                // 1. Multi-Select Filters
                for (let col in activeFilters) {
                    const allowed = activeFilters[col];
                    const rowVal = row[col];
                    // If no items selected loop logic: usually implies show none?
                    // Current UI flow: if 0 selected, allow none.
                    if (!allowed.includes(rowVal)) return false;
                }

                // 2. Global Search
                if (search) {
                    const rowStr = Object.values(row).join(' ').toLowerCase();
                    if (!rowStr.includes(search)) return false;
                }
                // 3. Overdue Filter
                const overdueOnly = document.getElementById('overdueFilter').checked;
                if (overdueOnly) {
                    const keyTarget = headers.find(h => h.toUpperCase() === 'TARGET DATE');
                    const keyStatus = headers.find(h => h.toUpperCase() === 'STATUS');
                    if (keyTarget) {
                        const rowDateStr = row[keyTarget];
                        const rowStatus = row[keyStatus] || '';
                        if (!rowDateStr) return false;

                        let rDate;
                        if (typeof rowDateStr === 'number') rDate = new Date((rowDateStr - (25567 + 2)) * 86400 * 1000);
                        else rDate = new Date(rowDateStr);

                        rDate.setHours(0, 0, 0, 0);
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        if (isNaN(rDate.getTime()) || rDate >= today) return false;

                        const validStatuses = ['YET TO START', 'DEV IN-PROGRESS', 'DEV COMPLETED'];
                        if (!validStatuses.some(s => String(rowStatus).toUpperCase().includes(s))) return false;
                    }
                }

                // 4. Date Range
                const dateStart = document.getElementById('dateStart').value;
                const dateEnd = document.getElementById('dateEnd').value;
                if (dateStart || dateEnd) {
                    const keyTarget = headers.find(h => h.toUpperCase() === 'TARGET DATE');
                    if (keyTarget) {
                        const rowDateStr = row[keyTarget];
                        if (!rowDateStr) return false;

                        let rDate;
                        if (typeof rowDateStr === 'number') rDate = new Date((rowDateStr - (25567 + 2)) * 86400 * 1000);
                        else rDate = new Date(rowDateStr);

                        if (isNaN(rDate.getTime())) return false;
                        if (dateStart && rDate < new Date(dateStart)) return false;
                        if (dateEnd) {
                            const d = new Date(dateEnd); d.setHours(23, 59, 59);
                            if (rDate > d) return false;
                        }
                    }
                }
                return true;
            });

            // Sort
            if (sortCol) {
                filteredData.sort((a, b) => {
                    let valA = a[sortCol] || "";
                    let valB = b[sortCol] || "";
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return sortAsc ? -1 : 1;
                    if (valA > valB) return sortAsc ? 1 : -1;
                    return 0;
                });
            } else {
                // Default: Show last record on top (LIFO)
                filteredData.reverse();
            }

            updateStats(filteredData);
            updateCharts(filteredData);
            renderTable(filteredData);
            renderTable(filteredData);
        }

        // --- DYNAMIC THEME ENGINE ---
        const colorThemes = [
            '#0ea5e9', // Sky Blue
            '#f43f5e', // Rose
            '#8b5cf6', // Violet
            '#10b981', // Emerald
            '#f59e0b', // Amber
            '#ec4899', // Pink
            '#14b8a6', // Teal
            '#6366f1', // Indigo
            '#f97316', // Orange
            '#06b6d4'  // Cyan
        ];

        let currentThemeColor = colorThemes[0];

        function applyRandomTheme() {
            const idx = Math.floor(Math.random() * colorThemes.length);
            currentThemeColor = colorThemes[idx];
            console.log("Applying Theme:", currentThemeColor);

            const root = document.documentElement;
            root.style.setProperty('--primary', currentThemeColor);

            // Generate hover (slightly darker)
            // Simple hex manipulation or just use same for now with opacity
            root.style.setProperty('--primary-hover', adjustBrightness(currentThemeColor, -15));
        }

        function adjustBrightness(col, amt) {
            let usePound = false;
            if (col[0] == "#") {
                col = col.slice(1);
                usePound = true;
            }
            let num = parseInt(col, 16);
            let r = (num >> 16) + amt;
            if (r > 255) r = 255; else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
        }
        function renderTable(data) {
            const total = data.length;
            const totalPages = Math.ceil(total / rowsPerPage);
            if (currentPage > totalPages) currentPage = 1;

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            const thead = document.querySelector('#mainTable thead');
            const tbody = document.querySelector('#mainTable tbody');
            thead.innerHTML = ''; tbody.innerHTML = '';

            const dateCols = ['DEV TEST CONDUCTED ON', 'QA TEST CONDUCTED ON', 'ALPHA TEST CONDUCTED ON', 'TARGET DATE'];

            let trH = document.createElement('tr');
            headers.forEach(h => {
                let th = document.createElement('th');
                th.innerHTML = h;
                if (sortCol === h) th.innerHTML += sortAsc ? ' <i class="fa-solid fa-caret-up"></i>' : ' <i class="fa-solid fa-caret-down"></i>';
                th.onclick = () => {
                    if (sortCol === h) sortAsc = !sortAsc;
                    else { sortCol = h; sortAsc = true; }
                    filterData();
                };
                const hUpper = h.toUpperCase();
                if (dateCols.includes(hUpper)) th.style.minWidth = '140px';
                else if (hUpper === 'DELIVERABLES' || hUpper === 'REMARKS') th.style.minWidth = '300px';
                else if (hUpper === 'PROJECT' || hUpper === 'APP') th.style.minWidth = '180px';
                trH.appendChild(th);
            });
            thead.appendChild(trH);

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center; padding: 2rem; color: #94a3b8;">No data found</td></tr>`;
            } else {
                pageData.forEach(row => {
                    let tr = document.createElement('tr');
                    headers.forEach(key => {
                        let td = document.createElement('td');
                        let val = row[key];
                        if (val === undefined || val === null) val = "";

                        if (dateCols.includes(key.toUpperCase()) && val) {
                            if (typeof val === 'number') {
                                const d = new Date((val - (25567 + 2)) * 86400 * 1000);
                                val = d.toISOString().split('T')[0];
                            } else {
                                try {
                                    const d = new Date(val);
                                    if (!isNaN(d.getTime())) val = d.toISOString().split('T')[0];
                                } catch (e) { }
                            }
                        }

                        if (key.toUpperCase() === 'STATUS') {
                            let badgeClass = 'badge-gray';
                            const vLower = String(val).toLowerCase();

                            if (vLower.includes('go-live') || vLower.includes('go live')) badgeClass = 'badge-golive';
                            else if (vLower.includes('completed')) badgeClass = 'badge-success';
                            else if (vLower.includes('dev')) badgeClass = 'badge-info';
                            else if (vLower.includes('qa') || vLower.includes('test') || vLower.includes('alpha') || vLower.includes('beta')) badgeClass = 'badge-cyan';
                            else if (vLower.includes('ready')) badgeClass = 'badge-indigo';
                            else if (vLower.includes('error') || vLower.includes('overdue')) badgeClass = 'badge-danger';
                            else if (vLower.includes('progress') || vLower.includes('start')) badgeClass = 'badge-warning';

                            td.innerHTML = `<span class="badge ${badgeClass}">${val}</span>`;
                        } else if (['DELIVERABLES', 'REMARKS'].includes(key.toUpperCase())) {
                            // Render HTML Content with overflow protection
                            td.innerHTML = String(val); // Allow HTML
                            td.style.whiteSpace = "normal"; // Wrap text
                            td.style.maxWidth = "400px";
                        } else {
                            td.innerText = val;
                        }

                        td.setAttribute('data-label', key);
                        td.onclick = () => showEditScreen(row);
                        td.style.cursor = 'pointer';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const div = document.getElementById('pagination');
            div.innerHTML = '';
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    let btn = document.createElement('div');
                    btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    btn.innerText = i;
                    btn.onclick = () => { currentPage = i; filterData(); };
                    div.appendChild(btn);
                } else if (div.lastChild && div.lastChild.innerText !== '...') {
                    let dots = document.createElement('div');
                    dots.innerText = '...';
                    dots.style.alignSelf = 'center';
                    div.appendChild(dots);
                }
            }
        }

        function updateStats(data) {
            document.getElementById('v-total').innerText = data.length;
            const keyStatus = headers.find(h => h.toUpperCase() === 'STATUS');
            if (keyStatus) {
                const done = data.filter(r => String(r[keyStatus] || '').toUpperCase().includes('COMPLETED') || String(r[keyStatus] || '').toUpperCase().includes('GO-LIVE')).length;
                const dev = data.filter(r => String(r[keyStatus] || '').toUpperCase().includes('DEV IN-PROGRESS')).length;
                const yet = data.filter(r => String(r[keyStatus] || '').toUpperCase().includes('YET TO START')).length;
                const hold = data.filter(r => String(r[keyStatus] || '').toUpperCase().includes('HOLD')).length;

                const keyTarget = headers.find(h => h.toUpperCase() === 'TARGET DATE');
                let overdue = 0;
                if (keyTarget) {
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    overdue = data.filter(r => {
                        const s = String(r[keyStatus] || '').toUpperCase();
                        let dVal = r[keyTarget];
                        if (!dVal) return false;

                        let d;
                        if (typeof dVal === 'number') d = new Date((dVal - (25567 + 2)) * 86400 * 1000);
                        else d = new Date(dVal);
                        if (isNaN(d.getTime())) return false;

                        if (d >= today) return false;
                        return ['YET TO START', 'DEV IN-PROGRESS'].some(st => s.includes(st));
                    }).length;
                }

                document.getElementById('v-done').innerText = done;
                document.getElementById('v-dev').innerText = dev;
                document.getElementById('v-yet').innerText = yet;
                document.getElementById('v-overdue').innerText = overdue;
                document.getElementById('v-hold').innerText = hold;
            }
        }

        function updateCharts(data) {
            const keyStatus = headers.find(h => h.toUpperCase() === 'STATUS');
            const keyOwner = headers.find(h => h.toUpperCase() === 'OWNER');
            const keyApp = headers.find(h => h.toUpperCase() === 'APP');
            const keyDate = headers.find(h => h.toUpperCase() === 'TARGET DATE');

            // --- DATA AGGREGATION ---
            const sCounts = {}, oCounts = {}, aCounts = {}, tCounts = {};

            data.forEach(r => {
                const s = r[keyStatus] || 'Unknown';
                const o = r[keyOwner] || 'Unassigned';
                const a = r[keyApp] || 'Other';

                sCounts[s] = (sCounts[s] || 0) + 1;
                oCounts[o] = (oCounts[o] || 0) + 1;
                aCounts[a] = (aCounts[a] || 0) + 1;

                if (keyDate && r[keyDate]) {
                    try {
                        let d;
                        if (typeof r[keyDate] === 'number') d = new Date((r[keyDate] - (25567 + 2)) * 86400 * 1000);
                        else d = new Date(r[keyDate]);

                        if (!isNaN(d.getTime())) {
                            const sortKey = d.toISOString().slice(0, 7); // 2025-10
                            tCounts[sortKey] = (tCounts[sortKey] || 0) + 1;
                        }
                    } catch (e) { }
                }
            });

            // --- STYLING & CONFIG ---
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            // Softer Palette for Professional Look
            const palette = {
                indigo: isDark ? '#818cf8cc' : '#6366f1cc', // Added opacity
                blue: isDark ? '#60a5facc' : '#3b82f6cc',
                emerald: isDark ? '#34d399cc' : '#10b981cc',
                amber: isDark ? '#fbbf24cc' : '#f59e0bcc',
                rose: isDark ? '#fb7185cc' : '#f43f5ecc',
                violet: isDark ? '#a78bfacc' : '#8b5cf6cc',
                cyan: isDark ? '#22d3eecc' : '#06b6d4cc',
                slate: isDark ? '#94a3b8cc' : '#64748bcc',
                goLiveGreen: isDark ? '#22c55e' : '#16a34a', // Lighter Green for Go-Live
                white: '#ffffff',
                bg: isDark ? '#1e293b' : '#ffffff',
                primary: currentThemeColor, // Use Dynamic Color
                primaryTransparent: currentThemeColor + '20' // 20 hex = approx 12% opacity
            };

            const getColorForStatus = (status) => {
                const s = String(status).toLowerCase();
                if (s.includes('go-live') || s.includes('go live')) return palette.goLiveGreen;
                if (s.includes('completed')) return palette.emerald;
                if (s.includes('dev')) return palette.blue;
                if (s.includes('qa') || s.includes('test') || s.includes('alpha') || s.includes('beta')) return palette.cyan;
                if (s.includes('ready')) return palette.indigo;
                if (s.includes('start') || s.includes('progress')) return palette.amber;
                if (s.includes('overdue') || s.includes('error')) return palette.rose;
                return palette.slate; // Default
            };

            const textColor = isDark ? '#e2e8f0' : '#475569';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? '#0f172a' : '#1e293b',
                        titleColor: '#f8fafc',
                        bodyColor: '#cbd5e1',
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        usePointStyle: true,
                        titleFont: { family: 'Inter', size: 14, weight: '600' },
                        bodyFont: { family: 'Inter', size: 13 }
                    }
                },
                layout: { padding: 10 }
            };

            // 1. STATUS BREAKDOWN
            if (charts.status) charts.status.destroy();
            const ctxS = document.getElementById('chartStatus').getContext('2d');
            charts.status = new Chart(ctxS, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sCounts),
                    datasets: [{
                        data: Object.values(sCounts),
                        backgroundColor: Object.keys(sCounts).map(s => getColorForStatus(s)),
                        borderWidth: 0,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: { family: 'Inter', size: 11 },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    layout: { padding: 10 }
                }
            });

            // 2. APPS DISTRIBUTION
            if (charts.apps) charts.apps.destroy();
            const ctxA = document.getElementById('chartApps').getContext('2d');
            let gradA = ctxA.createLinearGradient(0, 0, 0, 300);
            gradA.addColorStop(0, palette.primary); // Use Dynamic
            gradA.addColorStop(1, isDark ? palette.primaryTransparent : palette.primaryTransparent); // Hex opacity 10

            charts.apps = new Chart(ctxA, {
                type: 'bar',
                data: {
                    labels: Object.keys(aCounts),
                    datasets: [{
                        label: 'Tasks',
                        data: Object.values(aCounts),
                        backgroundColor: gradA,
                        hoverBackgroundColor: palette.primary,
                        borderRadius: 6,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { family: 'Inter' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { family: 'Inter' } }
                        }
                    }
                }
            });

            // 3. OWNER WORKLOAD (Line/Area)
            if (charts.owner) charts.owner.destroy();
            const ctxO = document.getElementById('chartOwner').getContext('2d');
            let gradO = ctxO.createLinearGradient(0, 0, 0, 300);
            gradO.addColorStop(0, palette.primary);
            gradO.addColorStop(1, isDark ? palette.primaryTransparent : palette.primaryTransparent);

            charts.owner = new Chart(ctxO, {
                type: 'line',
                data: {
                    labels: Object.keys(oCounts),
                    datasets: [{
                        label: 'Tasks',
                        data: Object.values(oCounts),
                        borderColor: palette.emerald,
                        borderWidth: 2,
                        backgroundColor: gradO,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: palette.bg,
                        pointBorderColor: palette.emerald,
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            grid: { color: gridColor, drawBorder: false, borderDash: [5, 5] },
                            ticks: { color: textColor, font: { family: 'Inter' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { family: 'Inter' } }
                        }
                    }
                }
            });

            // 4. DEADLINE TREND
            if (document.getElementById('chartTimeline')) {
                const ctxT = document.getElementById('chartTimeline').getContext('2d');
                if (charts.timeline) charts.timeline.destroy();

                const roundedMonths = Object.keys(tCounts).sort();
                const displayLabels = roundedMonths.map(k => {
                    const [y, m] = k.split('-');
                    const date = new Date(parseInt(y), parseInt(m) - 1, 1);
                    return date.toLocaleString('default', { month: 'short', year: '2-digit' });
                });

                let gradT = ctxT.createLinearGradient(0, 0, 0, 300);
                gradT.addColorStop(0, palette.cyan);
                gradT.addColorStop(1, isDark ? 'rgba(34, 211, 238, 0.1)' : 'rgba(8, 145, 178, 0.1)');

                charts.timeline = new Chart(ctxT, {
                    type: 'bar',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: 'Deadlines',
                            data: roundedMonths.map(k => tCounts[k]),
                            backgroundColor: gradT,
                            borderColor: palette.cyan,
                            borderWidth: 1,
                            borderRadius: 6,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: gridColor, drawBorder: false },
                                ticks: { color: textColor, font: { family: 'Inter' } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: textColor, font: { family: 'Inter' } }
                            }
                        }
                    }
                });
            }
        }

        function saveFilterState() {
            const state = {};
            // 1. Dynamic Dropdowns (Multi-Select)
            const params = document.querySelectorAll('.multi-select-container');
            params.forEach(con => {
                const col = con.getAttribute('data-col');
                const menu = con.querySelector('.multi-select-menu');
                // Check if all checked
                const allCb = menu.querySelector('input[value="All"]');
                if (!allCb.checked) {
                    // Only save if NOT all (i.e., specific filters applied)
                    const checkedValues = Array.from(menu.querySelectorAll('input[type="checkbox"]:not([value="All"]):checked')).map(cb => cb.value);
                    if (checkedValues.length > 0) state[col] = checkedValues;
                }
            });

            // 2. Global Controls
            state.search = document.getElementById('searchInput').value;
            state.dateStart = document.getElementById('dateStart').value;
            state.dateEnd = document.getElementById('dateEnd').value;
            state.overdue = document.getElementById('overdueFilter').checked;

            // 3. Sort
            state.sortCol = sortCol;
            state.sortAsc = sortAsc;

            return state;
        }

        function restoreFilterState(state) {
            if (!state) return;
            console.log("Restoring Filters:", state);

            // 1. Dynamic Dropdowns (Multi-Select)
            const params = document.querySelectorAll('.multi-select-container');
            params.forEach(con => {
                const col = con.getAttribute('data-col');
                if (state[col] && Array.isArray(state[col])) {
                    // User had specific options selected
                    const menu = con.querySelector('.multi-select-menu');
                    const allCb = menu.querySelector('input[value="All"]');
                    allCb.checked = false; // Uncheck all first

                    const boxes = menu.querySelectorAll('input[type="checkbox"]:not([value="All"])');
                    let foundCount = 0;
                    boxes.forEach(cb => {
                        if (state[col].includes(cb.value)) {
                            cb.checked = true;
                            foundCount++;
                        } else {
                            cb.checked = false;
                        }
                    });

                    // Update "Select All" Checkbox Status
                    const allChecked = Array.from(boxes).every(cb => cb.checked);
                    allCb.checked = allChecked;

                    // Update UI Label
                    const container = con;
                    const colName = container.getAttribute('data-col');
                    const triggerLabel = container.querySelector('.label');

                    const checkedCount = foundCount;
                    if (checkedCount === boxes.length) triggerLabel.innerText = colName;
                    else if (checkedCount === 0) triggerLabel.innerText = `${colName} (0)`;
                    else triggerLabel.innerText = `${colName} (${checkedCount})`;

                    // Edge Case: If restored value not found (e.g. DELETED), count mismatch is fine, strict restore.
                }
            });

            // 2. Global Controls
            if (state.search !== undefined) document.getElementById('searchInput').value = state.search;
            if (state.dateStart !== undefined) document.getElementById('dateStart').value = state.dateStart;
            if (state.dateEnd !== undefined) document.getElementById('dateEnd').value = state.dateEnd;
            if (state.overdue !== undefined) document.getElementById('overdueFilter').checked = state.overdue;

            // 3. Sort
            if (state.sortCol) {
                sortCol = state.sortCol;
                sortAsc = state.sortAsc;
                // Update header icons
                const ths = document.querySelectorAll('#mainTable th');
                ths.forEach(th => {
                    if (th.innerText.includes(sortCol)) {
                        // This is a bit tricky because innerText includes the icon. 
                        // But renderTable rebuilds them. 
                        // Actually filterData calls renderTable which rebuilds headers using current sortCol.
                        // So just setting the global variables is enough before calling filterData.
                    }
                });
            }

            filterData(); // Re-apply
        }

        function showDashboard() {
            document.getElementById('add-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            editingRow = null;
            // No need to clear filters here using code, just show the div
        }

        function showAddScreen() {
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.add('hidden');
            document.getElementById('add-screen').classList.remove('hidden');
            renderFormFields(document.getElementById('add-form-body'), null, 'add');
        }

        function showEditScreen(row) {
            editingRow = row;
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('add-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.remove('hidden');
            renderFormFields(document.getElementById('edit-form-body'), row, 'edit');
        }

        function renderFormFields(container, row, prefix) {
            container.innerHTML = '';
            headers.forEach(h => {
                let val = row ? row[h] : '';
                if (val === undefined || val === null) val = '';

                let hUpper = h.toUpperCase();

                if (['TARGET DATE'].includes(hUpper) && val) {
                    if (typeof val === 'number') {
                        const d = new Date((val - (25567 + 2)) * 86400 * 1000);
                        val = d.toISOString().split('T')[0];
                    } else {
                        try {
                            const d = new Date(val);
                            if (!isNaN(d.getTime())) val = d.toISOString().split('T')[0];
                        } catch (e) { }
                    }
                }

                let inputHtml = '';
                const id = `${prefix}-${sanitize(h)}`;

                if (hUpper === 'STATUS') {
                    const statusOptions = ["YET TO START", "DEV IN-PROGRESS", "DEV COMPLETED", "QA TEST", "ALPHA TEST", "BETA TEST", "READY FOR PRODUCTION", "GO-LIVE (COMPLETED)", "ON HOLD"];
                    let opts = statusOptions.map(opt => `<option value="${opt}" ${String(val).toUpperCase() === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    if (val && !statusOptions.includes(String(val).toUpperCase())) opts += `<option value="${val}" selected>${val}</option>`;
                    inputHtml = `<select class="form-input-field" id="${id}">${opts}</select>`;
                }
                else if (['DELIVERABLES', 'REMARKS'].includes(hUpper)) {
                    // Rich Text Editor HTML
                    inputHtml = `
                    <div class="rich-editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" onmousedown="formatDoc('bold')" title="Bold"><i class="fa-solid fa-bold"></i></button>
                            <button type="button" class="editor-btn" onmousedown="formatDoc('italic')" title="Italic"><i class="fa-solid fa-italic"></i></button>
                            <button type="button" class="editor-btn" onmousedown="formatDoc('underline')" title="Underline"><i class="fa-solid fa-underline"></i></button>
                            <button type="button" class="editor-btn" onmousedown="formatDoc('insertUnorderedList')" title="Bullet List"><i class="fa-solid fa-list-ul"></i></button>
                            <button type="button" class="editor-btn" onmousedown="formatDoc('insertOrderedList')" title="Numbered List"><i class="fa-solid fa-list-ol"></i></button>
                            <button type="button" class="editor-btn" onmousedown="formatDoc('removeFormat')" title="Clear Scaling"><i class="fa-solid fa-eraser"></i></button>
                            <div style="width:1px; background:var(--border); margin:0 4px;"></div>
                            <div class="editor-btn" style="position:relative; width:28px; padding:0;" title="Text Color">
                                <i class="fa-solid fa-palette" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none;"></i>
                                <input type="color" oninput="formatDoc('foreColor', this.value)" style="opacity:0; width:100%; height:100%; cursor:pointer; padding:0; border:none;">
                            </div>
                        </div>
                        <div class="editor-content form-input-field" id="${id}" contenteditable="true" style="border:none; border-top-left-radius:0; border-top-right-radius:0;">${val}</div>
                    </div>
                    <small style="color:var(--text-light); opacity:0.7;">* Use toolbar or keyboard shortcuts (Ctrl+B, Ctrl+I)</small>
                    `;
                }
                else if (hUpper === 'TARGET DATE') {
                    inputHtml = `<input type="date" class="form-input-field" id="${id}" value="${val}">`;
                }
                else if (['APP', 'PROJECT', 'OWNER'].includes(hUpper)) {
                    // Auto-complete logic
                    const uniqueVals = [...new Set(rawData.map(r => r[h]))].filter(v => v).sort();
                    const datalistId = `list-${id}`;
                    let options = uniqueVals.map(v => `<option value="${v}">`).join('');

                    inputHtml = `
                        <input class="form-input-field" id="${id}" list="${datalistId}" value="${val}" autocomplete="off">
                        <datalist id="${datalistId}">${options}</datalist>
                    `;
                }
                else {
                    inputHtml = `<input class="form-input-field" id="${id}" value="${val}">`;
                }

                container.innerHTML += `
                    <div class="input-group">
                        <label class="form-label">${h}</label>
                        ${inputHtml}
                    </div>
                `;
            });
        }

        function sanitize(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }

        function getFormData(prefix) {
            const newRow = {};
            headers.forEach(h => {
                const el = document.getElementById(`${prefix}-${sanitize(h)}`);
                if (el) {
                    // Check if it's our contenteditable div or a standard input
                    if (el.isContentEditable) {
                        newRow[h] = el.innerHTML.trim();
                    } else {
                        newRow[h] = el.value.trim();
                    }
                }
            });
            return newRow;
        }

        // --- RICH TEXT UTIL ---
        function formatDoc(cmd, value = null) {
            // Prevent focus loss only for buttons (mousedown), not inputs
            if (event && event.type === 'mousedown') {
                event.preventDefault();
            }
            document.execCommand(cmd, false, value);
        }

        async function saveAdd() {
            try {
                // Checkpoint 1
                console.log("Debug: Starting saveAdd");

                const newRow = getFormData('add');
                if (!newRow["PROJECT"] || !newRow["STATUS"]) {
                    alert("Validation Error: Project Name and Status are required!");
                    return;
                }

                if (mode === 'cloud') {
                    const btn = document.getElementById('saveBtn');
                    if (btn.innerText.includes("Read Only")) {
                        alert("Stop: File is Read-Only.");
                        return;
                    }

                    showLoader(true);

                    // Checkpoint 2
                    console.log("Debug: Fetching tables...");
                    const tables = await callGraph(`/me/drive/items/${itemId}/workbook/tables`);
                    if (!tables.value || tables.value.length === 0) throw new Error("No Table found.");
                    const tableId = tables.value[0].id;

                    // Checkpoint 3
                    console.log("Debug: Table ID found:", tableId);

                    const columnsData = await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/columns`);
                    const tableColumns = columnsData.value.map(c => c.name.toUpperCase());

                    // Checkpoint 4
                    console.log("Debug: Columns fetched:", tableColumns.join(", "));

                    // Mapping
                    const map = {
                        "APP": ["APP", "APPLICATION", "SYSTEM"],
                        "PROJECT": ["PROJECT", "INITIATIVE", "TITLE", "NAME", "PROJECT NAME"],
                        "DELIVERABLES": ["DELIVERABLES", "TASK", "ITEM", "DESCRIPTION"],
                        "OWNER": ["OWNER", "ASSIGNED TO", "LEAD", "RESPONSIBLE"],
                        "TARGET DATE": ["TARGET DATE", "DUE DATE", "DEADLINE", "END DATE"],
                        "STATUS": ["STATUS", "STATE", "STAGE"],
                        "REMARKS": ["REMARKS", "COMMENTS", "NOTES"]
                    };

                    const rowArray = tableColumns.map(colName => {
                        const stdKey = Object.keys(map).find(k =>
                            map[k].some(alias => colName.includes(alias)) || k === colName
                        );
                        return stdKey ? (newRow[stdKey] || "") : "";
                    });

                    // Checkpoint 5
                    console.log("Debug: Payload:", JSON.stringify(rowArray));

                    const postRes = await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/rows`, 'POST', {
                        values: [rowArray]
                    });

                    // Checkpoint 6
                    console.log("Debug: POST Success:", postRes);

                    alert("Task Added Successfully!");
                    await loadCloudFile(itemId, "OneDrive File", true);
                    showDashboard();

                } else {
                    rawData.push(newRow);
                    filterData();
                    showDashboard();
                }
            } catch (e) {
                console.error("CRITICAL SAVE ERROR:", e);
                alert("Error during save: " + e.message);
            } finally {
                showLoader(false);
            }
        }

        async function saveEdit() {
            if (!editingRow) return;

            // Validation
            const newRow = getFormData('edit');
            if (!newRow["PROJECT"] || !newRow["STATUS"]) {
                alert("Project Name and Status are required!");
                return;
            }

            if (mode === 'cloud') {
                const btn = document.getElementById('saveBtn');
                if (btn.innerText.includes("Read Only")) {
                    alert("Cannot update: Read-Only Mode.");
                    return;
                }

                if (typeof editingRow._rowIndex === 'undefined') { alert("Missing row index."); return; }

                showLoader(true);
                try {
                    const tables = await callGraph(`/me/drive/items/${itemId}/workbook/tables`);
                    if (!tables.value || tables.value.length === 0) throw new Error("No Table found.");
                    const tableId = tables.value[0].id;

                    // Get Columns
                    const columnsData = await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/columns`);
                    const tableColumns = columnsData.value.map(c => c.name.toUpperCase());

                    const map = {
                        "APP": ["APP", "APPLICATION", "SYSTEM"],
                        "PROJECT": ["PROJECT", "INITIATIVE", "TITLE", "NAME"],
                        "DELIVERABLES": ["DELIVERABLES", "TASK", "ITEM", "DESCRIPTION"],
                        "OWNER": ["OWNER", "ASSIGNED TO", "LEAD", "RESPONSIBLE"],
                        "TARGET DATE": ["TARGET DATE", "DUE DATE", "DEADLINE", "END DATE"],
                        "STATUS": ["STATUS", "STATE", "STAGE"],
                        "REMARKS": ["REMARKS", "COMMENTS", "NOTES"]
                    };

                    const rowArray = tableColumns.map(colName => {
                        const stdKey = Object.keys(map).find(k =>
                            map[k].some(alias => colName.includes(alias)) || k === colName
                        );
                        return stdKey ? (newRow[stdKey] || "") : "";
                    });

                    await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/rows/itemAt(index=${editingRow._rowIndex})`, 'PATCH', {
                        values: [rowArray]
                    });

                    alert("Task updated successfully!");
                    await loadCloudFile(itemId, "OneDrive File", true);
                    showDashboard();
                } catch (e) { alert("Sync Error: " + e.message); }
                showLoader(false);
            } else {
                Object.assign(editingRow, newRow);
                filterData();
                showDashboard();
            }
        }

        async function deleteTask() {
            if (!editingRow) {
                alert("Internal Error: No active row selected to delete.");
                return;
            }
            if (!confirm("Are you sure you want to delete this record?")) return;

            if (mode === 'cloud') {
                const btn = document.getElementById('saveBtn');
                if (btn.innerText.includes("Read Only")) {
                    alert("Stop: File is Read-Only.");
                    return;
                }

                if (typeof editingRow._rowIndex === 'undefined') {
                    alert("Error: Cannot delete row with missing index.");
                    return;
                }

                showLoader(true);
                try {
                    // Optimized: Use cached ID if available
                    let tableId = currentTableId;
                    if (!tableId) {
                        console.log("Debug: Fetching tables for delete (cache miss)...");
                        const tables = await callGraph(`/me/drive/items/${itemId}/workbook/tables`);
                        if (!tables.value || tables.value.length === 0) throw new Error("No Table found.");
                        tableId = tables.value[0].id;
                        currentTableId = tableId;
                    }

                    console.log("Debug: Deleting row at index:", editingRow._rowIndex);

                    try {
                        await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/rows/itemAt(index=${editingRow._rowIndex})`, 'DELETE');
                        alert("Task Deleted Successfully!");
                    } catch (e) {
                        // Handle Conflict (e.g. Table geometry prevents row deletion)
                        if (e.message.includes("409") || e.message.includes("Conflict")) {
                            console.warn("Delete blocked by Excel (409). Attempting Soft Delete (Clear Row)...");

                            // 1. Get Column Count
                            const columnsData = await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/columns`);
                            const colCount = columnsData.value.length;

                            // 2. Clear Row Values
                            const emptyRow = new Array(colCount).fill("");
                            await callGraph(`/me/drive/items/${itemId}/workbook/tables/${tableId}/rows/itemAt(index=${editingRow._rowIndex})`, 'PATCH', {
                                values: [emptyRow]
                            });

                            alert("Record cleared. (Row kept to preserve Excel structure)");
                        } else {
                            throw e;
                        }
                    }
                    await loadCloudFile(itemId, "OneDrive File", true);
                    showDashboard();
                } catch (e) {
                    console.error("Delete Error:", e);
                    alert("Error deleting row: " + e.message);
                }
                showLoader(false);
            } else {
                const idx = rawData.indexOf(editingRow);
                if (idx > -1) rawData.splice(idx, 1);
                filterData();
                showDashboard();
            }
        }

    </script>
    <script>
        // --- REMOVE PRELOADER ON LOAD ---
        window.addEventListener('load', () => {
            const preloader = document.getElementById('app-preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                preloader.style.visibility = 'hidden';
                setTimeout(() => { preloader.remove(); }, 500);
            }
            document.body.style.opacity = '1';
        });
    </script>
</body>

</html>
